<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>SOP æŒ‡æŒ¥å®˜é›·è¾¾ (Hybrid Core)</title>
  <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.2.37/lunar.js"></script>
  <style>
    :root {
      --bg: #000; --card: #1c1c1e; --text: #e5e5e5;
      --gold: #d4a017; --red: #ff453a; --green: #32d74b; --purple: #bf5af2;
    }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;margin:0;padding:16px;background:var(--bg);color:var(--text);line-height:1.5}
    .card{background:var(--card);border:1px solid #333;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 4px 20px rgba(0,0,0,0.4)}
    
    /* é¡¶éƒ¨ä»ªè¡¨ç›˜ */
    .hero { border: 1px solid var(--gold); background: linear-gradient(160deg, #1c1c1e 60%, #2c2a20 100%); }
    .hero-title { color:var(--gold); font-size:12px; text-transform:uppercase; letter-spacing:1px; margin-bottom:12px; opacity:0.8; font-weight:bold;}
    
    .grid-row { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .grid-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #333; }
    .grid-item:last-child { border-bottom: none; }
    .cat-label { font-size: 13px; color: #888; }
    .cat-val { font-size: 15px; font-weight: bold; color: #fff; }
    .cat-score { font-family: monospace; font-weight: 800; margin-left: 6px; }
    
    /* æ§åˆ¶åŒº */
    .row{display:flex;gap:10px;align-items:center}
    input,select{background:#000;color:#fff;border:1px solid #444;padding:12px;border-radius:8px;font-size:15px;flex:1;outline:none;-webkit-appearance:none;}
    button{background:var(--gold);color:#000;border:none;font-weight:bold;padding:12px 20px;border-radius:8px;font-size:15px}
    
    /* è¯¦æƒ…åŒº */
    .badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:12px;font-weight:bold;margin-right:6px;vertical-align:text-bottom;}
    .good{background:rgba(50,215,75,0.15);color:var(--green);border:1px solid rgba(50,215,75,0.3)}
    .bad{background:rgba(255,69,58,0.15);color:var(--red);border:1px solid rgba(255,69,58,0.3)}
    .mid{background:rgba(255,255,255,0.1);color:#aaa;border:1px solid #444}
    .void{background:rgba(191,90,242,0.15);color:var(--purple);border:1px solid rgba(191,90,242,0.3)}
    
    .log-item{font-size:13px; margin-bottom:8px; padding:10px; background:#252527; border-radius:8px; color:#ccc;}
    .log-title { font-weight: bold; color: #fff; display: block; margin-bottom: 4px; font-size: 14px;}
    .log-desc { color: #999; line-height: 1.4; }
    .warn-text {color: var(--gold);}
  </style>
</head>
<body>

<div class="card hero">
  <div class="hero-title">ä»Šæ—¥æˆ˜æœ¯æƒ…æŠ¥ (Daily Intel)</div>
  <div id="heroContent" class="grid-row">
    <div style="text-align:center; padding:10px; color:#666">æ­£åœ¨è¿æ¥å«æ˜Ÿæ•°æ®...</div>
  </div>
</div>

<div class="card">
  <div class="row">
    <input id="d" type="date" onchange="autoRun()" />
    <button onclick="setToday()">ä»Šæ—¥</button>
  </div>
  <div class="row" style="margin-top:12px">
    <select id="mode" onchange="runAnalysis()">
      <optgroup label="A. èµ„æœ¬ä¸æ‰©å¼ ">
        <option value="A1">A1 è‚¡æƒ/å¤§é¢æŠ•èµ„</option>
        <option value="A2">A2 ç°é‡‘æµ/æ”¶è´¦</option>
        <option value="A3">A3 å®ä½“åº—æ‰©å¼ /SOP</option>
        <option value="A4">A4 ç­¾çº¦/æ³•åŠ¡</option>
      </optgroup>
      <optgroup label="B. å…³ç³»ä¸åšå¼ˆ">
        <option value="B1">B1 äº²å¯†å…³ç³» (Iris)</option>
        <option value="B2">B2 å•†åŠ¡è°ˆåˆ¤/åšå¼ˆ</option>
        <option value="B3">B3 å‘˜å·¥/ç®¡ç†</option>
        <option value="B4">B4 ç¤¾äº¤/å…¬å…³</option>
      </optgroup>
      <optgroup label="C. èº«ä½“ä¸èƒ½é‡">
        <option value="C1">C1 30kméª‘è¡Œ/é«˜èƒ½</option>
        <option value="C2">C2 åŒ»ç–—/æ‰‹æœ¯</option>
        <option value="C3">C3 ç‚ç—‡/ç¡çœ /å†…è€—</option>
        <option value="C4">C4 é£æ°´/èƒ½é‡åœº</option>
      </optgroup>
    </select>
  </div>
</div>

<div id="resultArea"></div>

<script>
// ==========================================
// 1. åŸºç¡€æ•°æ®åº“ (High Precision Core)
// ==========================================
const NATAL = {
  year: { tg:"å£¬", dz:"æˆŒ" },
  month: { tg:"åºš", dz:"æˆŒ" },
  day:   { tg:"å·±", dz:"ä¸‘" }, // æ ¸å¿ƒ
  hour:  { tg:"åºš", dz:"åˆ" }
};

// è§£é‡Šåº“ (Intelligence Dictionary)
const REL_DICT = {
  'å†²': {
    'A': 'âš ï¸ **åŠ¨è¡/å˜æ•°**ï¼šåˆåŒæœ‰æ¼æ´ï¼Œèµ„é‡‘å¡é¡¿ã€‚å¿Œä¸å¯æ’¤é”€çš„å†³å®šã€‚',
    'B': 'âš¡ï¸ **å†²çª/å¯¹ç«‹**ï¼šæƒ…ç»ªä¸Šå¤´ï¼Œå®¹æ˜“è¯èµ¶è¯ã€‚é€‚åˆå†·å¤„ç†ã€‚',
    'C': 'ğŸš‘ **å†²å‡»/æ„å¤–**ï¼šéª‘è¡Œæ³¨æ„è·¯å†µï¼Œå…³èŠ‚æ˜“å—ä¼¤ã€‚ç¦æ­¢æé™æŒ‘æˆ˜ã€‚'
  },
  'åˆ‘': {
    'A': 'ğŸ”’ **çº ç»“/å†…è€—**ï¼šè¡¨é¢æ²¡äº‹ï¼Œå†…éƒ¨æµç¨‹å¡æ­»ã€‚SOPæ‰§è¡Œä¸é¡ºã€‚',
    'B': 'ğŸ”ª **æŒ‘å‰”/æŠ˜ç£¨**ï¼šäº’ç›¸çœ‹ç€ä¸é¡ºçœ¼ï¼Œç¿»æ—§è´¦ã€‚å¿ƒé‡Œæœ‰ç«å‘ä¸å‡ºã€‚',
    'C': 'ğŸ”¥ **ç‚ç—‡/ç„¦è™‘**ï¼šç²¾ç¥å†…è€—ä¸¥é‡ï¼Œå¤±çœ ï¼Œæ—§ä¼¤éšç—›ã€‚'
  },
  'å®³': {
    'A': 'âŒ **å°äºº/æš—è€—**ï¼šè®¾å¤‡è«åæŸåï¼Œæˆ–è¢«éšæ€§æ¡æ¬¾å‘ã€‚',
    'B': 'â„ï¸ **è¯¯è§£/éš”é˜‚**ï¼šæ²Ÿé€šæ— æ•ˆï¼Œè¶Šæè¶Šé»‘ã€‚ä¸è¦å¼ºè¡Œè§£é‡Šã€‚',
    'C': 'ğŸ¦  **è™šå¼±/ç—…ç¬¦**ï¼šå…ç–«åŠ›ä¸‹é™ï¼Œè«åç–²æƒ«ï¼Œæ˜“æ„Ÿå†’ã€‚'
  },
  'åˆ': {
    'A': 'ğŸ¤ **ç¨³å®š/ç¾ç»Š**ï¼šåˆ©äºç­¾çº¦ï¼Œä½†ä¹Ÿå¯èƒ½èµ„é‡‘è¢«é”ä½ï¼ˆæµåŠ¨æ€§å·®ï¼‰ã€‚',
    'B': 'â¤ï¸ **èæ´½/ç²˜äºº**ï¼šé€‚åˆä¿®å¤å…³ç³»ï¼Œå¯¹æ–¹æ¯”è¾ƒå¬è¯ã€‚',
    'C': 'ğŸ›Œ **æ…µæ‡’/æ¢å¤**ï¼šä¸æƒ³åŠ¨ï¼Œåªæƒ³èººç€ã€‚é€‚åˆä¼‘æ¯ï¼Œä¸é€‚åˆç ´PBã€‚'
  },
  'ä¼åŸ': 'ğŸ” **é‡å¤/åœæ»**ï¼šäº‹æƒ…ååå¤å¤ï¼Œåƒé¬¼æ‰“å¢™ã€‚å»ºè®®åŸåœ°å¾…å‘½ï¼Œæ•´ç†å†…åŠ¡ã€‚',
  'ååŸ': 'ğŸ’¥ **åè½¬/å†²å‡»**ï¼šäº‹æƒ…çªç„¶å˜å¦ã€‚å¿…é¡»å‡†å¤‡Plan Bã€‚',
  'ç«æ¯’': 'â›”ï¸ **ç«æ¯’æ”»å¿ƒ**ï¼šå¤ªå²ä¸™åˆå åŠ å¤ç«ã€‚ç¦æ­¢ç†¬å¤œï¼Œç¦æ­¢ç‡¥çƒ­é£Ÿç‰©ã€‚',
  'ç©ºäº¡': 'â­•ï¸ **èƒ½é‡ä¸­ç©º**ï¼šæ‰¿è¯ºä¸å…‘ç°ï¼Œåšå¤šé”™å¤šã€‚åªé€‚åˆæ€è€ƒï¼Œä¸é€‚åˆè½åœ°ã€‚'
};

// ä½ çš„åå¥½é…ç½® (Use God)
const PREF = {
  like: ["é‡‘", "ç«"], 
  ok:   ["åœŸ"],
  wary: ["æœ¨", "æ°´"]
};

// æµ®ç‚¹æ•°æƒé‡çŸ©é˜µ (Precision Matrix from Index.html)
const MODE = {
  'A1': { wx: {é‡‘:1.25, ç«:0.85, åœŸ:0.55, æœ¨:-1.05, æ°´:-0.55}, rel: {å†²:-2.0, åˆ‘:-1.5, å®³:-1.0, åˆ:+0.7}, extra: {fanyin:-2.5, fuyin:-1.2} },
  'A2': { wx: {é‡‘:1.10, ç«:0.70, åœŸ:0.45, æœ¨:-0.85, æ°´:+0.20}, rel: {å†²:-1.6, åˆ‘:-1.2, å®³:-0.9, åˆ:+0.7}, extra: {fanyin:-2.0, fuyin:-1.0} },
  'A3': { wx: {é‡‘:1.20, ç«:0.95, åœŸ:0.75, æœ¨:-0.95, æ°´:-0.45}, rel: {å†²:-1.6, åˆ‘:-1.3, å®³:-0.8, åˆ:+0.6}, extra: {fanyin:-1.9, fuyin:-0.9} },
  'A4': { wx: {é‡‘:1.05, ç«:0.95, åœŸ:0.45, æœ¨:-0.70, æ°´:-0.20}, rel: {å†²:-2.2, åˆ‘:-1.8, å®³:-1.2, åˆ:+1.0}, extra: {fanyin:-2.5, fuyin:-1.0} },
  'B1': { wx: {é‡‘:0.85, ç«:0.55, åœŸ:0.35, æœ¨:-1.10, æ°´:+0.15}, rel: {å†²:-1.8, åˆ‘:-1.4, å®³:-1.1, åˆ:+1.2}, extra: {fanyin:-2.2, fuyin:-1.2} },
  'B2': { wx: {é‡‘:1.30, ç«:0.65, åœŸ:0.45, æœ¨:-1.05, æ°´:-0.10}, rel: {å†²:-1.5, åˆ‘:-1.2, å®³:-1.0, åˆ:+0.8}, extra: {fanyin:-2.0, fuyin:-1.0} },
  'B3': { wx: {é‡‘:1.00, ç«:0.60, åœŸ:0.55, æœ¨:-0.85, æ°´:-0.10}, rel: {å†²:-1.6, åˆ‘:-1.4, å®³:-1.3, åˆ:+0.7}, extra: {fanyin:-1.9, fuyin:-1.0} },
  'B4': { wx: {é‡‘:1.05, ç«:0.85, åœŸ:0.25, æœ¨:-0.70, æ°´:+0.25}, rel: {å†²:-1.2, åˆ‘:-1.0, å®³:-0.9, åˆ:+0.8}, extra: {fanyin:-1.6, fuyin:-0.8} },
  'C1': { wx: {é‡‘:0.55, ç«:0.40, åœŸ:0.25, æœ¨:-0.70, æ°´:-0.35}, rel: {å†²:-2.5, åˆ‘:-2.0, å®³:-1.2, åˆ:+0.4}, extra: {fanyin:-3.0, fuyin:-1.5} },
  'C2': { wx: {é‡‘:0.45, ç«:0.30, åœŸ:0.20, æœ¨:-0.65, æ°´:-0.25}, rel: {å†²:-2.5, åˆ‘:-2.5, å®³:-1.5, åˆ:+0.3}, extra: {fanyin:-3.0, fuyin:-2.0} },
  'C3': { wx: {é‡‘:0.60, ç«:-2.0, åœŸ:-0.5, æœ¨:-0.55, æ°´:+0.80}, rel: {å†²:-1.5, åˆ‘:-1.5, å®³:-1.2, åˆ:+0.5}, extra: {fanyin:-2.2, fuyin:-1.5} },
  'C4': { wx: {é‡‘:0.60, ç«:0.30, åœŸ:0.20, æœ¨:-0.55, æ°´:-0.25}, rel: {å†²:-1.8, åˆ‘:-1.5, å®³:-1.1, åˆ:+0.4}, extra: {fanyin:-2.2, fuyin:-1.3} }
};

const TG_WX = {ç”²:"æœ¨",ä¹™:"æœ¨",ä¸™:"ç«",ä¸:"ç«",æˆŠ:"åœŸ",å·±:"åœŸ",åºš:"é‡‘",è¾›:"é‡‘",å£¬:"æ°´",ç™¸:"æ°´"};
const DZ_WX = {å­:"æ°´",ä¸‘:"åœŸ",å¯…:"æœ¨",å¯:"æœ¨",è¾°:"åœŸ",å·³:"ç«",åˆ:"ç«",æœª:"åœŸ",ç”³:"é‡‘",é…‰:"é‡‘",æˆŒ:"åœŸ",äº¥:"æ°´"};
const CHONG = new Set(["å­åˆ","åˆå­","ä¸‘æœª","æœªä¸‘","å¯…ç”³","ç”³å¯…","å¯é…‰","é…‰å¯","è¾°æˆŒ","æˆŒè¾°","å·³äº¥","äº¥å·³"]);
const XING = new Set(["å­å¯","å¯å­","å¯…å·³","å·³ç”³","ç”³å¯…","ä¸‘æˆŒ","æˆŒæœª","æœªä¸‘","è¾°è¾°","åˆåˆ","é…‰é…‰","äº¥äº¥"]);
const HAI = new Set(["å­æœª","æœªå­","ä¸‘åˆ","åˆä¸‘","å¯…å·³","å·³å¯…","å¯è¾°","è¾°å¯","ç”³äº¥","äº¥ç”³","é…‰æˆŒ","æˆŒé…‰"]);
const HE_LIU = new Set(["å­ä¸‘","ä¸‘å­","å¯…äº¥","äº¥å¯…","å¯æˆŒ","æˆŒå¯","è¾°é…‰","é…‰è¾°","å·³ç”³","ç”³å·³","åˆæœª","æœªåˆ"]);
const KONG_WANG = ['åˆ', 'æœª'];

// ==========================================
// 2. æ ¸å¿ƒè®¡ç®—å¼•æ“ (Engine)
// ==========================================

function getWxScore(wx, modeKey) {
  let score = MODE[modeKey].wx[wx] || 0;
  if (PREF.like.includes(wx)) score += 0.5;
  if (PREF.wary.includes(wx)) score -= 0.3;
  return score;
}

function getExplanation(type, modeKey) {
  const cat = modeKey.charAt(0); // 'A', 'B', 'C'
  if (REL_DICT[type]) {
    if (typeof REL_DICT[type] === 'string') return REL_DICT[type]; // é€šç”¨è§£é‡Š
    return REL_DICT[type][cat] || REL_DICT[type]['A'];
  }
  return '';
}

function checkRelations(flowDz, modeKey) {
  let score = 0;
  let logs = [];
  const myDz = [NATAL.year.dz, NATAL.month.dz, NATAL.day.dz, NATAL.hour.dz];
  const rw = MODE[modeKey].rel;
  const pName = ['å¹´','æœˆ','æ—¥','æ—¶'];

  myDz.forEach((nz, idx) => {
    const pair = flowDz + nz;
    let type = '';
    let s = 0;
    
    if (CHONG.has(pair)) { type='å†²'; s=rw.å†²; }
    else if (XING.has(pair)) { type='åˆ‘'; s=rw.åˆ‘; }
    else if (HAI.has(pair)) { type='å®³'; s=rw.å®³; }
    else if (HE_LIU.has(pair)) { type='åˆ'; s=rw.åˆ; }
    
    if (type) {
      score += s;
      logs.push({
        t: type, 
        title: `${flowDz} (æµæ—¥) - ${nz} (æœ¬å‘½${pName[idx]}) ${type}`,
        desc: getExplanation(type, modeKey),
        s: s
      });
    }
    
    if (flowDz === nz) {
      score += MODE[modeKey].extra.fuyin;
      logs.push({
        t: 'ä¼åŸ', 
        title: `${flowDz} (æµæ—¥) ä¼åŸ æœ¬å‘½${pName[idx]}`,
        desc: getExplanation('ä¼åŸ', modeKey),
        s: MODE[modeKey].extra.fuyin
      });
    }
  });
  
  return {score, logs};
}

function analyze(dateStr, modeKey) {
  const d = new Date(dateStr);
  const solar = Solar.fromYmd(d.getFullYear(), d.getMonth() + 1, d.getDate());
  const lunar = solar.getLunar();
  const bazi = lunar.getEightChar();
  
  const yearGZ = bazi.getYear();
  const monthGZ = bazi.getMonth();
  const dayGZ = bazi.getDay();
  const dGan = dayGZ[0];
  const dZhi = dayGZ[1];
  const mZhi = monthGZ[1]; 
  
  let totalScore = 0;
  let details = [];
  let isVoid = false;

  // A. äº”è¡Œå¾—åˆ†
  const tgScore = getWxScore(TG_WX[dGan], modeKey) * 1.0; 
  const dzScore = getWxScore(DZ_WX[dZhi], modeKey) * 0.8; 
  totalScore += (tgScore + dzScore);
  
  // B. å…³ç³»å¾—åˆ†
  const relRes = checkRelations(dZhi, modeKey);
  totalScore += relRes.score;
  details = relRes.logs;
  // --- ä»²è£é€»è¾‘ (SOP Arbitrator) ---
  // è§£å†³â€œæ—¢åˆåˆå†²â€çš„çŸ›ç›¾æ˜¾ç¤º
  const hasChong = details.some(x => x.t === 'å†²');
  const hasHe = details.some(x => x.t === 'åˆ');
  
  if (hasChong && hasHe) {
    // 1. å…ˆæŠŠåŸæ¥çŸ›ç›¾çš„å•æ¡è§£é‡Šæ ‡è®°ä¸ºâ€œæŠ˜å â€æˆ–ç›´æ¥åˆ é™¤ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©æ¸…ç©ºå¹¶é‡å†™
    // ä½†ä¸ºäº†ä¿ç•™å…·ä½“å†²äº†è°çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬åªä¿ç•™titleï¼Œé‡å†™desc
    
    // 2. ç”Ÿæˆç»¼åˆå»ºè®®
    let synthesis = '';
    if (modeKey.startsWith('B')) { // å…³ç³»ç±»ç‰¹åŒ–
      synthesis = 'âš ï¸ **çˆ±æ¨äº¤ç»‡ (Complex)**ï¼šä»Šæ—¥èƒ½é‡æå…¶æ‹‰æ‰¯ã€‚æ—¥æ”¯å—åˆï¼ˆæƒ³äº²è¿‘ï¼‰ï¼Œæ—¶æ”¯å—å†²ï¼ˆæ˜“åµæ¶ï¼‰ã€‚\nğŸ‘‰ **SOP**ï¼šåªè°ˆæƒ…ï¼ˆäº«å—åˆï¼‰ï¼Œä¸è°ˆäº‹ï¼ˆé¿å…å†²ï¼‰ã€‚ä¸€æ—¦æ„Ÿè§‰æ°”æ°›ä¸å¯¹ï¼Œç«‹åˆ»ç‰©ç†æ’¤é€€ï¼Œä¸è¦è¯•å›¾â€œæŠŠè¯è®²æ¸…æ¥šâ€ã€‚';
    } else if (modeKey.startsWith('A')) { // è´¢åŠ¡ç±»ç‰¹åŒ–
      synthesis = 'âš ï¸ **å…ˆæˆåè´¥ (Volatile)**ï¼šè¡¨é¢è°ˆå¾—å¥½ï¼ˆåˆï¼‰ï¼Œè½åœ°å…¨æ˜¯å‘ï¼ˆå†²ï¼‰ã€‚\nğŸ‘‰ **SOP**ï¼šå¯ä»¥ç­¾æ„å‘ä¹¦ï¼Œä½†ä¸è¦ä»˜å…¨æ¬¾ã€‚';
    } else {
      synthesis = 'âš ï¸ **éœ‡è¡æ¨¡å¼**ï¼šå‰å‡¶åŒæ˜¾ï¼Œè¿‡ç¨‹èˆ’æœï¼Œç»“æœæŠ˜è…¾ã€‚';
    }

    // 3. æš´åŠ›æ’å…¥ä¸€æ¡æœ€é«˜ä¼˜å…ˆçº§çš„â€œå‚è°‹å»ºè®®â€
    details.unshift({
      t: 'çº ç¼ ',
      title: 'âš¡ï¸ å†²åˆå¹¶è§ (Conflict & Harmony)',
      desc: synthesis,
      s: -5 // è¿™ç§æ—¥å­é€šå¸¸æ¶ˆè€—æå¤§ï¼Œç»™ä¸ªè´Ÿåˆ†è­¦ç¤º
    });
    
    // 4. (å¯é€‰) å¦‚æœä½ æƒ³æŠŠåŸæ¥é‚£ä¸¤æ¡çŸ›ç›¾çš„åˆ æ‰ï¼Œå¯ä»¥è¿‡æ»¤ä¸€ä¸‹ï¼Œæˆ–è€…å°±ç•™ç€å½“åº•å±‚æ•°æ®
    // details = details.filter(d => d.t !== 'å†²' && d.t !== 'åˆ'); // è¿™ä¸€è¡Œçœ‹ä½ å–œå¥½ï¼Œæˆ‘å»ºè®®ä¿ç•™ä½†æŠŠæ–°å»ºè®®ç½®é¡¶
  }


  // C. 2026 ç‰¹ä¾›è¡¥ä¸
  // å¤ç«ç†”é‡‘
  if (yearGZ.includes('ä¸™åˆ') && ['å·³','åˆ','æœª'].includes(mZhi)) {
    if (MODE[modeKey].wx['é‡‘'] > 0.8) {
      totalScore -= 3.0;
      details.unshift({t:'ç«æ¯’', title:'å¤ç«ç†”é‡‘', desc: getExplanation('ç«æ¯’', modeKey), s:-3.0});
    }
    if (modeKey === 'C3') {
      totalScore -= 5.0;
      details.unshift({t:'é«˜å±', title:'ç«æ¯’æ”»å¿ƒ', desc:'â›”ï¸ æçƒ­æ¨¡å¼ï¼šå¿…é¡»å¼ºåˆ¶ä¼‘æ¯ï¼Œç‰©ç†é™æ¸©ã€‚', s:-5.0});
    }
  }

  // ç©ºäº¡
  if (KONG_WANG.includes(dZhi)) {
    isVoid = true;
    if (modeKey.startsWith('A')) {
      totalScore = -10; 
      details.unshift({t:'ç©ºäº¡', title:'ç©ºäº¡æ—¥ (åˆ/æœª)', desc: getExplanation('ç©ºäº¡', modeKey), s:-99});
    } else {
      totalScore *= 0.5; 
      details.unshift({t:'ç©ºäº¡', title:'ç©ºäº¡æ—¥', desc: 'âš ï¸ èƒ½é‡å‡åŠï¼Œäº‹å€åŠŸåŠã€‚', s:0});
    }
  }

  let grade = 'ä¸­å¹³';
  let css = 'mid';
  if (totalScore >= 3.5) { grade = 'ä¼˜ (A-Tier)'; css = 'good'; }
  else if (totalScore >= 1.0) { grade = 'è‰¯ (B-Tier)'; css = 'mid'; }
  else if (totalScore <= -3.0) { grade = 'å‡¶ (Risk)'; css = 'bad'; }
  if (isVoid && modeKey.startsWith('A')) { grade = 'ç†”æ–­ (VOID)'; css = 'void'; }

  return {
    score: totalScore.toFixed(1),
    grade, css, details,
    gz: `${yearGZ}å¹´ ${monthGZ}æœˆ ${dayGZ}æ—¥`
  };
}

// ==========================================
// 3. UI Logic (Dashboard)
// ==========================================

function autoRun() {
  const dVal = document.getElementById("d").value;
  if (!dVal || typeof Solar === 'undefined') return;
  
  // 1. åˆ†ç±»è®¡ç®—æœ€é«˜åˆ†
  let bestA = {s:-999, n:'', k:''}, bestB = {s:-999, n:'', k:''}, bestC = {s:-999, n:'', k:''};
  
  const options = document.querySelectorAll('#mode option');
  options.forEach(opt => {
    const key = opt.value;
    const name = opt.text.split(' ')[1]; // å–å‡º "è‚¡æƒ/å¤§é¢æŠ•èµ„"
    const res = analyze(dVal, key);
    const s = parseFloat(res.score);
    
    if (key.startsWith('A') && s > bestA.s) bestA = {s:s, n:name, k:key};
    if (key.startsWith('B') && s > bestB.s) bestB = {s:s, n:name, k:key};
    if (key.startsWith('C') && s > bestC.s) bestC = {s:s, n:name, k:key};
  });

  // 2. æ¸²æŸ“é¡¶éƒ¨ Grid
  const getCol = (s) => s > 3 ? '#32d74b' : (s < 0 ? '#ff453a' : '#d4a017');
  
  const html = `
    <div class="grid-item">
      <span class="cat-label">ğŸ’° A. èµ„æœ¬</span>
      <div><span class="cat-val">${bestA.n}</span> <span class="cat-score" style="color:${getCol(bestA.s)}">${bestA.s}</span></div>
    </div>
    <div class="grid-item">
      <span class="cat-label">ğŸ¤ B. å…³ç³»</span>
      <div><span class="cat-val">${bestB.n}</span> <span class="cat-score" style="color:${getCol(bestB.s)}">${bestB.s}</span></div>
    </div>
    <div class="grid-item">
      <span class="cat-label">ğŸ§˜ C. èº«ä½“</span>
      <div><span class="cat-val">${bestC.n}</span> <span class="cat-score" style="color:${getCol(bestC.s)}">${bestC.s}</span></div>
    </div>
  `;
  document.getElementById('heroContent').innerHTML = html;
  
  runAnalysis(); 
}

function runAnalysis() {
  const dVal = document.getElementById("d").value;
  const modeKey = document.getElementById("mode").value;
  if (!dVal) return;
  
  const res = analyze(dVal, modeKey);
  const modeName = document.getElementById("mode").selectedOptions[0].text;
  
  let html = `
    <div class="card" style="border-left:4px solid ${getColor(res.css)}">
      <div style="display:flex;justify-content:space-between;align-items:baseline">
        <span style="font-family:monospace;font-size:16px;color:#aaa">${res.gz}</span>
        <span class="badge ${res.css}" style="font-size:14px">${res.grade} ${res.score}</span>
      </div>
      <div style="margin-top:8px;font-size:14px;color:#888">å½“å‰æ¨¡å¼: <span style="color:#fff">${modeName}</span></div>
      
      <div style="margin-top:16px;border-top:1px solid #333;padding-top:12px">
        <div style="font-size:12px;color:#666;text-transform:uppercase;margin-bottom:8px">æˆ˜æœ¯æƒ…æŠ¥è§£ç  (Intel)</div>
  `;
  
  if (res.details.length === 0) {
    html += `<div class="log-item">âœ… èƒ½é‡åœºçº¯å‡€ï¼Œæ— æ˜æ˜¾å†²åˆ‘å¹²æ‰°ï¼ŒSOP æ­£å¸¸æ‰§è¡Œã€‚</div>`;
  } else {
    res.details.forEach(log => {
      const color = log.s < 0 ? '#ff453a' : '#32d74b';
      const tagColor = log.s < 0 ? 'rgba(255,69,58,0.2)' : 'rgba(50,215,75,0.2)';
      
      html += `
      <div class="log-item" style="border-left:3px solid ${color}">
        <span class="log-title">
          <span style="background:${tagColor};color:${color};padding:2px 4px;border-radius:3px;font-size:11px;margin-right:4px">[${log.t}]</span>
          ${log.title}
        </span>
        <div class="log-desc">${log.desc}</div>
      </div>`;
    });
  }
  
  html += `</div></div>`;
  document.getElementById('resultArea').innerHTML = html;
}

function getColor(c) {
  if (c==='good') return '#32d74b';
  if (c==='bad') return '#ff453a';
  if (c==='void') return '#bf5af2';
  return '#d4a017';
}

function setToday() {
  const dt = new Date();
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,'0');
  const day = String(dt.getDate()).padStart(2,'0');
  document.getElementById('d').value = `${y}-${m}-${day}`;
  autoRun();
}

window.onload = () => {
  setToday();
  setTimeout(autoRun, 500); 
};
</script>
</body>
</html>
